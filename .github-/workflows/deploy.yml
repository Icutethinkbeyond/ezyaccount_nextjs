name: Deploy to Server

on:
  push:
    branches:
      - main  # Trigger ‡πÄ‡∏°‡∏∑‡πà‡∏≠ push ‡πÑ‡∏õ‡∏¢‡∏±‡∏á branch main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Secrets
    - name: Validate Secrets
      run: |
        REQUIRED_SECRETS=("SSH_PRIVATE_KEY" "DATABASE_URL" "NEXTAUTH_SECRET" "NEXTAUTH_URL" "API_PYTHON")
        for SECRET in "${REQUIRED_SECRETS[@]}"; do
          # ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á secrets ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] && [ "$SECRET" == "SSH_PRIVATE_KEY" ]; then
            echo "‚ùå Missing SSH_PRIVATE_KEY in Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.DATABASE_URL }}" ] && [ "$SECRET" == "DATABASE_URL" ]; then
            echo "‚ùå Missing DATABASE_URL in Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.NEXTAUTH_SECRET }}" ] && [ "$SECRET" == "NEXTAUTH_SECRET" ]; then
            echo "‚ùå Missing NEXTAUTH_SECRET in Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.NEXTAUTH_URL }}" ] && [ "$SECRET" == "NEXTAUTH_URL" ]; then
            echo "‚ùå Missing NEXTAUTH_URL in Secrets"
            exit 1
          fi
          if [ -z "${{ secrets.API_PYTHON }}" ] && [ "$SECRET" == "API_PYTHON" ]; then
            echo "‚ùå Missing API_PYTHON in Secrets"
            exit 1
          fi
        done
        echo "‚úÖ All required Secrets are present."

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: Checkout ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å GitHub
    - name: Checkout Code
      uses: actions/checkout@v3

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SSH
    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST_NAME }} >> ~/.ssh/known_hosts

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ SSH
    - name: Test SSH Connection
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.HOST_NAME }} "echo 'SSH connection successful'"

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5: Deploy ‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    - name: Deploy Code to VPS Server
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.HOST_NAME }} << 'EOF'

          set -e  # ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ error

          # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÅ‡∏•‡∏∞ repository URL
          REPO_DIR="/home/cutting-GUI-system"
          REPO_URL="git@github.com:Icutethinkbeyond/cutting-GUI-system.git"

          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå repository ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if [ -d "$REPO_DIR" ]; then
              echo "‚úÖ Directory exists. Checking for updates..."
              cd $REPO_DIR

              # ‡∏î‡∏∂‡∏á commit hash ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å remote
              REMOTE_COMMIT=$(git ls-remote $REPO_URL refs/heads/main | awk '{print $1}')
              LOCAL_COMMIT=$(git rev-parse HEAD)

              # ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö commit hash
              if [ "$REMOTE_COMMIT" != "$LOCAL_COMMIT" ]; then
                  echo "‚úÖ Local repository is out of sync. Pulling latest changes..."
                  git fetch --all
                  git reset --hard origin/main
              else
                  echo "‚úÖ Repository is already up to date."
              fi
          else
              echo "‚ùå Directory does not exist. Cloning repository..."
              cd /home
              git clone $REPO_URL
              cd $REPO_DIR
          fi
        EOF

    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 6: Deploy ‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
    - name: Nginx Settings
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.HOST_NAME }} << 'EOF'

          set -e  # ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ error
          # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÅ‡∏•‡∏∞ repository URL

          DOMAIN="cutting.icutethink.online"
          REPO_DIR="/home/cutting-GUI-system/nginx"
          ADMIN_EMAIL="thanapognchunchombun@gmail.com"

          # ‡πÉ‡∏ä‡πâ find ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
          # CONF_FILE=$(find /home/cutting-GUI-system -name "*.conf" | head -n 1)

          cd $REPO_DIR

          # ‡πÉ‡∏ä‡πâ find ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
          if [ ! -f "$DOMAIN" ]; then
            echo "‚ùå Configuration file $DOMAIN not found in $REPO_DIR"
            exit 1
          else
            echo "‚úÖ Found $DOMAIN in $REPO_DIR"
          fi
          
          echo "‚úÖ Moving Nginx File..."
          cp $DOMAIN -f /etc/nginx/sites-available/
          
          # ‡∏™‡∏£‡πâ‡∏≤‡∏á symbolic link ‡πÑ‡∏õ‡∏ó‡∏µ‡πà /etc/nginx/sites-enabled/
          # ln -sf /etc/nginx/sites-available/$(basename $CONF_FILE) /etc/nginx/sites-enabled/
          echo "‚úÖ Linking Nginx File..."
          ln -sf /etc/nginx/sites-available/$DOMAIN /etc/nginx/sites-enabled/

          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö syntax ‡∏Ç‡∏≠‡∏á Nginx
          echo "üîç Checking Nginx configuration syntax..."
          sudo nginx -t
          if [ $? -ne 0 ]; then
              echo "‚ùå Nginx configuration syntax error"
              exit 1
          fi

          # ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó nginx
          echo "‚úÖ Restarting Nginx..."
          systemctl restart nginx

           # ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á SSL
           echo "‚úÖ Installing SSL..."
          sudo certbot --nginx -d $DOMAIN -d $DOMAIN --non-interactive --agree-tos --redirect --email $ADMIN_EMAIL

          # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SSL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏î‡πÄ‡∏°‡∏ô
          # if ! certbot certificates | grep -q "$DOMAIN"; then
            # echo "‚ùå SSL not found. Installing SSL..."
            # certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email $ADMIN_EMAIL
            # sudo certbot --nginx -d $DOMAIN -d $DOMAIN --non-interactive --agree-tos --redirect --email $ADMIN_EMAIL

          # else
            # echo "‚úÖ SSL is already installed."
          # fi
        EOF


    # ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 7: Run Docker Image
    - name: Run Docker Image And Cleaning
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa root@${{ secrets.HOST_NAME }} << 'EOF'

          set -e  # ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠ error
          REPO_DIR="/home/cutting-GUI-system"

          cd $REPO_DIR

          # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .env ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
          echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" > .env.production
          echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> .env.production
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.production
          echo "API_PYTHON=${{ secrets.API_PYTHON }}" >> .env.production

          # Run Docker Container
          docker stop cutting-system || true
          docker rm cutting-system || true
          # docker-compose up -d
          docker-compose rm -f
          docker-compose pull
          docker-compose up --build -d
          docker system prune -a -f

          # ‡∏•‡∏ö Environment Variables ‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå .env
          unset NEXTAUTH_SECRET NEXTAUTH_URL DATABASE_URL API_PYTHON
          rm -f .env

          echo "‚úÖ Deployment completed and cleaned up."
        EOF
