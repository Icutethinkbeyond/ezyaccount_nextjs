"use client";

import React, { useState, useEffect } from "react";
import {
    Card,
    CardContent,
    Grid,
    TextField,
    Button,
    Box,
    CircularProgress,
} from "@mui/material";
import PageContainer from "@/components/shared/PageContainer";
import PageHeader from "@/components/shared/PageHeader";
import { useRouter } from "next/navigation";
import FormSection from "@/components/shared/FormSection";
import { CompanyProfile } from "@/interfaces/Company";

interface CompanyFormProps {
    title?: string;
    onSuccess?: () => void;
    companyId?: string; // Optional: If provided, Edit Mode. If not, Create Mode.
}

interface CompanyFormData {
    companyName: string;
    companyTaxId: string;
    companyAddress: string;
    companyPhoneNumber: string;
    companyEmail: string;
    companyWebsite: string;
    companyBusinessType: string;
    companyRegistrationDate: string;
}

export default function CompanyForm({ title = "ข้อมูลบริษัท", onSuccess, companyId }: CompanyFormProps) {
    const router = useRouter();
    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);
    const [formData, setFormData] = useState<CompanyFormData>({
        companyName: "",
        companyTaxId: "",
        companyAddress: "",
        companyPhoneNumber: "",
        companyEmail: "",
        companyWebsite: "",
        companyBusinessType: "",
        companyRegistrationDate: "",
    });

    useEffect(() => {
        if (companyId) {
            fetchCompanyData(companyId);
        } else {
            setLoading(false);
        }
    }, [companyId]);

    const fetchCompanyData = async (id: string) => {
        try {
            setLoading(true);
            const res = await fetch(`/api/companies/${id}`);
            if (res.ok) {
                const data: CompanyProfile = await res.json();
                if (data) {
                    setFormData({
                        companyName: data.companyName || "",
                        companyTaxId: data.companyTaxId || "",
                        companyAddress: data.companyAddress || "",
                        companyPhoneNumber: data.companyPhoneNumber || "",
                        companyEmail: data.companyEmail || "",
                        companyWebsite: data.companyWebsite || "",
                        companyBusinessType: data.companyBusinessType || "",
                        companyRegistrationDate: data.companyRegistrationDate
                            ? new Date(data.companyRegistrationDate).toISOString().split('T')[0]
                            : "",
                    });
                }
            }
        } catch (error) {
            console.error("Failed to fetch company data", error);
            alert("Failed to load company data");
        } finally {
            setLoading(false);
        }
    };

    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setFormData((prev) => ({
            ...prev,
            [name]: value,
        }));
    };

    const handleSave = async () => {
        try {
            setSaving(true);
            const method = companyId ? "PUT" : "POST";
            const endpoint = companyId ? `/api/companies/${companyId}` : "/api/companies";

            const res = await fetch(endpoint, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });

            if (res.ok) {
                alert("บันทึกข้อมูลสำเร็จ");
                if (onSuccess) {
                    onSuccess();
                }
                router.push("/company");
            } else {
                const errorData = await res.json();
                alert(errorData.error || "บันทึกข้อมูลไม่สำเร็จ");
            }
        } catch (error) {
            console.error("Error saving data:", error);
            alert("เกิดข้อผิดพลาดในการเชื่อมต่อ");
        } finally {
            setSaving(false);
        }
    };

    if (loading) {
        return (
            <Box sx={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '400px' }}>
                <CircularProgress />
            </Box>
        );
    }

    return (
        <PageContainer title={title} description="Manage company details">
            <PageHeader title={title} />
            <Box mt={3}>
                <Card elevation={0} sx={{ border: '1px solid #e5eaef' }}>
                    <CardContent sx={{ p: 4 }}>
                        <FormSection title="ข้อมูลบริษัท">
                            <Grid container spacing={2}>
                                <Grid item xs={12} md={6}>
                                    <TextField
                                        fullWidth
                                        label="ชื่อบริษัท"
                                        name="companyName"
                                        value={formData.companyName}
                                        onChange={handleChange}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                                <Grid item xs={12} md={6}>
                                    <TextField
                                        fullWidth
                                        label="เบอร์โทร"
                                        name="companyPhoneNumber"
                                        value={formData.companyPhoneNumber}
                                        onChange={handleChange}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                                <Grid item xs={12}>
                                    <TextField
                                        fullWidth
                                        label="เลขที่เสียภาษี"
                                        name="companyTaxId"
                                        value={formData.companyTaxId}
                                        onChange={handleChange}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                                <Grid item xs={12}>
                                    <TextField
                                        fullWidth
                                        label="วันที่จดทะเบียน"
                                        name="companyRegistrationDate"
                                        value={formData.companyRegistrationDate}
                                        onChange={handleChange}
                                        type="date"
                                        variant="outlined"
                                        size="small"
                                        InputLabelProps={{ shrink: true }}
                                    />
                                </Grid>
                                <Grid item xs={12}>
                                    <TextField
                                        fullWidth
                                        label="ที่อยู่"
                                        name="companyAddress"
                                        value={formData.companyAddress}
                                        onChange={handleChange}
                                        multiline
                                        rows={3}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                                <Grid item xs={12} md={6}>
                                    <TextField
                                        fullWidth
                                        label="อีเมล"
                                        name="companyEmail"
                                        value={formData.companyEmail}
                                        onChange={handleChange}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                                <Grid item xs={12} md={6}>
                                    <TextField
                                        fullWidth
                                        label="เว็บไซต์"
                                        name="companyWebsite"
                                        value={formData.companyWebsite}
                                        onChange={handleChange}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                                <Grid item xs={12} md={6}>
                                    <TextField
                                        fullWidth
                                        label="ประเภทธุรกิจ"
                                        name="companyBusinessType"
                                        value={formData.companyBusinessType}
                                        onChange={handleChange}
                                        variant="outlined"
                                        size="small"
                                    />
                                </Grid>
                            </Grid>
                        </FormSection>
                        <Box mt={3}>
                            <Button
                                variant="contained"
                                color="success"
                                size="large"
                                fullWidth
                                onClick={handleSave}
                                disabled={saving}
                                sx={{ color: "white" }}
                            >
                                {saving ? "กำลังบันทึก..." : "บันทึกข้อมูล"}
                            </Button>
                        </Box>
                    </CardContent>
                </Card>
            </Box>
        </PageContainer>
    );
}
