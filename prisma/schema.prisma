generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// User & Auth (คงเดิม)
// --------------------------------------

model User {
  userId       String     @id @default(auto()) @map("_id") @db.ObjectId
  username     String?
  userEmail    String     @unique
  userPassword String
  userStatus   UserStatus @default(Active)
  name         String?
  phone        String?

  // Relations
  account Account?
  role    Role?   @relation(fields: [roleId], references: [roleId])
  roleId  String? @db.ObjectId

  profile        Profile?
  companyProfile CompanyProfile?
  address        String?
  resetTokens    ResetToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userEmail, username])
}

model Profile {
  profileId      String  @id @default(auto()) @map("_id") @db.ObjectId
  profileName    String?
  profileSurname String?
  profileimage   String?
  profilePhone   String?

  user   User?   @relation(fields: [userId], references: [userId])
  userId String? @unique @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  provider          String
  providerAccountId String?
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  user              User           @relation(fields: [userId], references: [userId])
  userId            String         @unique @db.ObjectId
  verified          VerifiedStatus @default(UnVerified)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
}

model ResetToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  token     String   @unique
  expires   DateTime
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [userId])
  createdAt DateTime @default(now())
}

model Role {
  roleId      String   @id @default(auto()) @map("_id") @db.ObjectId
  name        RoleName
  description String?
  users       User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name])
}

// --------------------------------------
// Company & Business (คงเดิม)
// --------------------------------------

model CompanyProfile {
  companyId               String    @id @default(auto()) @map("_id") @db.ObjectId
  companyName             String
  companyAddress          String?
  companyTaxId            String?
  companyPhoneNumber      String?
  companyEmail            String?
  companyWebsite          String?
  companyRegistrationDate DateTime?
  companyBusinessType     String?
  user                    User      @relation(fields: [userId], references: [userId])
  userId                  String    @unique @db.ObjectId

  customerCompanies CustomerCompany[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerCompany {
  customerCompanyId    String  @id @default(auto()) @map("_id") @db.ObjectId
  companyName          String
  companyTel           String?
  customerCompanyEmail String?
  taxId                String?
  branch               String?
  companyAddress       String?

  companyProfile CompanyProfile? @relation(fields: [companyId], references: [companyId])
  companyId      String?         @db.ObjectId

  documentPapers DocumentPaper[]
  contactors     Contactor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contactor {
  contactorId      String  @id @default(auto()) @map("_id") @db.ObjectId
  contactorName    String
  contactorEmail   String?
  contactorTel     String?
  contactorAddress String?

  customerCompany   CustomerCompany? @relation(fields: [customerCompanyId], references: [customerCompanyId])
  customerCompanyId String?          @db.ObjectId

  documentPapers DocumentPaper[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// Products Inventory (คงเดิม)
// Note: Category ตรงนี้คือหมวดหมู่สินค้าในคลัง ไม่ใช่หมวดหมู่ในใบเสนอราคา
// --------------------------------------

model Category {
  categoryId   String    @id @default(auto()) @map("_id") @db.ObjectId
  categoryName String
  categoryDesc String?
  products     Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  productId          String  @id @default(auto()) @map("_id") @db.ObjectId
  productName        String
  productSKU         String?
  productDescription String?
  productImage       String?

  aboutProduct AboutProduct?
  category     Category?     @relation(fields: [categoryId], references: [categoryId])
  categoryId   String?       @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AboutProduct {
  aboutProductId String @id @default(auto()) @map("_id") @db.ObjectId

  product   Product @relation(fields: [productId], references: [productId], onDelete: Cascade)
  productId String  @unique @db.ObjectId

  productPrice         Float?  @default(0)
  productDiscountPrice Float?  @default(0)
  productStock         Int?    @default(0)
  productBrand         String?
  unitName             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// Documents (Quotation/Invoice) - Redesigned for PricingContext
// --------------------------------------

model DocumentPaper {
  documentId   String @id @default(auto()) @map("_id") @db.ObjectId
  documentIdNo String @unique
  
  // Details
  docType         String // เช่น "Quotation"
  docMonth        String?
  docYear         String?
  documentDetials String? // (Typo เดิมจาก schema คุณ หากแก้ในโค้ดแล้วให้แก้ตรงนี้เป็น documentDetails)

  // Relations
  customerCompany   CustomerCompany? @relation(fields: [customerCompanyId], references: [customerCompanyId])
  customerCompanyId String?          @db.ObjectId

  contactor   Contactor? @relation(fields: [contactorId], references: [contactorId])
  contactorId String?    @db.ObjectId

  // Status & Dates
  documentType   eDocumentType  @default(Quotation)
  documentStatus DocumentStatus @default(Draft)
  
  documentCreateDate DateTime? @default(now())
  documentExpire     DateTime?

  // ------------------------------------------------------------------
  // ✅ Fields for PricingContext Global State
  // ------------------------------------------------------------------
  includeVat      Boolean @default(false) // ตรงกับ state: vatIncluded
  taxRate         Float   @default(7)     // ตรงกับ state: taxRate
  globalDiscount  Float   @default(0)     // ตรงกับ state: discount (ส่วนลดท้ายบิล)
  
  // ✅ Summary Fields (Calculated values)
  subTotal           Float @default(0) // ราคารวมก่อนลด
  totalAfterDiscount Float @default(0) // ราคาหลังหักส่วนลด
  vatAmount          Float @default(0) // มูลค่าภาษี
  grandTotal         Float @default(0) // ราคาสุทธิ (Net Total)
  withholdingTax     Float @default(0) // หัก ณ ที่จ่าย (เผื่อไว้)

  // ------------------------------------------------------------------
  // ✅ Relation to Categories (Structure from Context)
  // ------------------------------------------------------------------
  // เปลี่ยนจาก items เดิมที่เป็น DocumentProduct มาเป็น structure ใหม่
  categories DocumentCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ Model นี้เปรียบเสมือน interface Category ใน PricingContext
model DocumentCategory {
  categoryId String @id @default(auto()) @map("_id") @db.ObjectId
  name       String // ชื่อหมวดหมู่ (เช่น "งานโครงสร้าง")
  
  // Relation back to Paper
  documentPaper   DocumentPaper @relation(fields: [documentPaperId], references: [documentId], onDelete: Cascade)
  documentPaperId String        @db.ObjectId

  // Relation to SubItems
  items DocumentItem[]

  // Ordering: เพื่อให้เรียงลำดับหมวดหมู่ได้ถูกต้อง
  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ✅ Model นี้เปรียบเสมือน interface SubItem ใน PricingContext
model DocumentItem {
  itemId String @id @default(auto()) @map("_id") @db.ObjectId
  
  name         String? // ชื่อสินค้า
  description  String  // รายละเอียด
  unit         String  // หน่วย
  qty          Float   @default(1)
  pricePerUnit Float   @default(0)
  remark       String? // หมายเหตุ
  
  // Calculation helper (Optional: เก็บผลคูณ qty * price เพื่อ query ง่ายขึ้น)
  totalPrice Float @default(0) 

  // Relation back to Category
  category   DocumentCategory @relation(fields: [categoryId], references: [categoryId], onDelete: Cascade)
  categoryId String           @db.ObjectId

  // Ordering
  orderIndex Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// Enums (คงเดิม)
// --------------------------------------

enum eDocumentType {
  Quotation
}

enum DocumentStatus {
  Draft
  Waiting
  Approve
  Cancel
}

enum VerifiedStatus {
  Verified
  UnVerified
}

enum UserStatus {
  Active
  InActice
}

enum RoleName {
  Developer
  Administrator
  User
  Customer
}

enum ProviderAccount {
  Google
  Facebook
  Email
}